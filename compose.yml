version: "3.8"

services:
  # Redis Database
  redis:
    image: redis:8-alpine
    container_name: spreadsheet-redis
    volumes:
      - redis-data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - spreadsheet-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # RedisInsight - Database Admin UI
  redisinsight:
    image: redis/redisinsight:latest
    container_name: spreadsheet-redisinsight
    volumes:
      - redisinsight-data:/data
    networks:
      - spreadsheet-network
    environment:
      - REDIS_HOSTS=${REDIS_HOSTS:-local:redis:6379}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy

  # Backend
  backend:
    image: ${DOCKER_USERNAME}/spreadsheet-server:${TAG:-latest}
    container_name: spreadsheet-server
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${BACKEND_PORT:-4000}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
    networks:
      - spreadsheet-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:4000/health",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Frontend - React SPA
  frontend:
    image: ${DOCKER_USERNAME}/spreadsheet-docs:${TAG:-latest}
    container_name: spreadsheet-frontend
    environment:
      - VITE_API_URL=${VITE_API_URL}
    networks:
      - spreadsheet-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:80",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: spreadsheet-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
    networks:
      - spreadsheet-network
    depends_on:
      - frontend
      - backend
      - redisinsight
    restart: unless-stopped

networks:
  spreadsheet-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
  redisinsight-data:
    driver: local
